// ... [باقي الكود قبل دالة processImage يبقى كما هو] ...

// **دالة رسم المخطط النظيف (بدلاً من عرض الصورة المعالجة)**
function drawCleanSketch(analysis) {
    const scale = 5; // عامل تصغير لرسم المخطط
    const canvasWidth = analysis.overallWidth / scale;
    const canvasHeight = analysis.overallHeight / scale;
    
    outputCanvas.width = canvasWidth;
    outputCanvas.height = canvasHeight * 1.5; // إضافة مساحة للسقف
    outputCanvas.style.display = 'block';
    
    const ctx = outputCanvas.getContext('2d');
    ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
    
    const startX = 20;
    const startY = outputCanvas.height - 20; 
    const bodyWidth = canvasWidth - 40;
    const bodyHeight = canvasHeight * 0.8;
    const roofAngle = analysis.slopeAngle; 

    // إعداد قلم الرسم (المهندس)
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 1.5;
    
    // 1. رسم جسم المبنى (Building Body)
    ctx.strokeRect(startX, startY - bodyHeight, bodyWidth, bodyHeight);
    
    // 2. رسم السقف المائل (Pitched Roof)
    const roofBaseY = startY - bodyHeight;
    const roofHeight = bodyWidth * Math.tan(roofAngle * Math.PI / 180) * 0.5;
    const roofMidX = startX + bodyWidth / 2;
    
    ctx.beginPath();
    ctx.moveTo(startX, roofBaseY);
    ctx.lineTo(roofMidX, roofBaseY - roofHeight); // النقطة العلوية
    ctx.lineTo(startX + bodyWidth, roofBaseY);
    ctx.stroke();

    // 3. رسم خطوط الطوابق (Floor Lines - AI Assistance)
    const floorHeightPx = bodyHeight / analysis.floorCount;
    for (let i = 1; i < analysis.floorCount; i++) {
        const floorY = startY - (i * floorHeightPx);
        ctx.beginPath();
        ctx.moveTo(startX, floorY);
        ctx.lineTo(startX + bodyWidth, floorY);
        ctx.stroke();
    }
    
    // 4. رسم النوافذ التقريبي (Window Approximation)
    const windowSpacing = bodyWidth / (analysis.windowCount + 1);
    const windowWidthPx = analysis.squareWindowWidth / scale;
    const windowHeightPx = floorHeightPx * 0.5;

    for (let f = 0; f < analysis.floorCount; f++) {
        const floorBaseY = startY - (f * floorHeightPx);
        for (let w = 1; w <= analysis.windowCount; w++) {
            const wx = startX + (w * windowSpacing) - (windowWidthPx / 2);
            const wy = floorBaseY - floorHeightPx * 0.75;
            
            ctx.strokeRect(wx, wy, windowWidthPx, windowHeightPx);
        }
    }
}


function processImage() {
    if (!imageLoaded) return;

    statusMessage.textContent = 'Traitement en cours...';
    processButton.disabled = true;
    actionButtons.style.display = 'none'; 
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    
    progressBar.style.display = 'block';
    progressPercent.style.display = 'block';
    progressBar.value = 0;
    progressPercent.textContent = '0%';
    measurementsDiv.innerHTML = 'Analyse en cours...';
    
    const scaleFactor = parseFloat(scaleFactorInput.value) || 100; 
    const floorCount = parseInt(floorCountInput.value) || 1; 
    const windowType = windowTypeInput.value; 
    
    const img = new Image();
    img.onload = function() {
        // [هنا لن نقوم برسم الصورة الأصلية مباشرة]
        
        // **الآن سنقوم باستخلاص القياسات دون محاولة تنظيف الصورة**
        // سنحتاج Worker فقط لتحليل العرض والارتفاع وعدد النوافذ
        
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = img.width;
        tempCanvas.height = img.height;
        tempCtx.drawImage(img, 0, 0);
        const imageData = tempCtx.getImageData(0, 0, img.width, img.height);
        
        const worker = new Worker('worker.js?v=7'); // استخدام Worker لتحليل الأبعاد فقط
        
        worker.onmessage = function(e) {
            if (e.data.type === 'progress') {
                progressBar.value = e.data.percent;
                progressPercent.textContent = e.data.percent + '%';
                statusMessage.textContent = `Analyse des contours... ${e.data.percent}% terminé`;
            } else if (e.data.type === 'result') {
                const analysis = e.data.analysis;
                
                // **الخطوة الحاسمة: رسم المخطط النظيف بناءً على القياسات**
                drawCleanSketch(analysis); 

                // عرض القياسات
                let htmlOutput = '<h4>Mesures en Pixels (Approximation):</h4>';
                htmlOutput += `<li>**Largeur Totale (Overall Width):** ${analysis.overallWidth} px</li>`;
                htmlOutput += `<li>**Hauteur Totale (Overall Height):** ${analysis.overallHeight} px</li>`;
                htmlOutput += `<li style="color: #007bff;">**التحسين بالذكاء الاصطناعي:** تم استخدام ${analysis.floorCount} طابق للحسابات.</li>`;
                htmlOutput += `<li>**النافذة (Square/Arched):** ${analysis.windowCount} (${analysis.windowType})</li>`;
                htmlOutput += `<li>**Angle de Pente de Toit (Roof Slope):** ${analysis.slopeAngle}°</li>`;
                
                htmlOutput += '<div class="unit-conversion">';
                htmlOutput += '<h4>Conversions en Mètres (m):</h4>';
                htmlOutput += `<li>**Facteur د\'échelle:** 1 mètre = ${scaleFactor} pixels</li>`;
                htmlOutput += `<li>**العرض الكلي:** ${analysis.widthMeters.toFixed(2)} m</li>`;
                htmlOutput += `<li>**الارتفاع الكلي (تقريبي):** ${analysis.heightMeters.toFixed(2)} m</li>`;
                htmlOutput += `<li>**ارتفاع الطابق:** ${analysis.floorHeightMeters.toFixed(2)} m (مستند لـ ${analysis.floorCount} طابق)</li>`;
                htmlOutput += `<li>**متوسط عرض النافذة:** ${analysis.squareWindowWidthMeters.toFixed(2)} m</li>`;
                htmlOutput += '</div>';

                measurementsDiv.innerHTML = htmlOutput;

                statusMessage.textContent = '✅ Génération de l\'esquisse terminée ! رسم هندسي نظيف جاهز للتصميم.';
                actionButtons.style.display = 'flex'; 
                processButton.disabled = false;
                progressBar.style.display = 'none';
                progressPercent.style.display = 'none';
                worker.terminate();
            }
        };

        worker.postMessage({ 
            imageData, 
            width: img.width, 
            height: img.height,
            scaleFactor: scaleFactor,
            floorCount: floorCount, 
            windowType: windowType 
        }, [imageData.data.buffer]);
    };

    img.src = originalImage.src;
}

// ... [باقي الكود بعد دالة processImage يبقى كما هو] ...
