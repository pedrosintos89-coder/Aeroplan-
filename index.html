<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroPlan | Outil √âco-esth√©tique</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
            text-align: center;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #28a745; 
            border-bottom: 3px solid #28a745;
            padding-bottom: 10px;
            margin-bottom: 25px;
        }
        .controls {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px dashed #28a74555;
            border-radius: 8px;
        }
        .controls label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .controls input[type="file"], .controls input[type="number"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 90%;
            max-width: 300px;
            margin-top: 5px;
        }
        .image-display {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .image-box {
            width: 48%;
            min-width: 350px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        img, canvas {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        progress {
            accent-color: #28a745;
            height: 15px;
        }
        .unit-conversion {
            margin-top: 20px;
            padding: 15px;
            border-top: 2px solid #28a745;
            border-bottom: 2px solid #28a745;
            margin-top: 25px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üìê AeroPlan: G√©n√©rateur de Plans A√©riens</h1>
    <p>Convertissez les images a√©riennes de b√¢timents en sch√©mas filaires d'ing√©nierie (Wireframes) avec mesures en pixels et en m√®tres.</p>

    <div class="controls">
        <label for="imageUpload">
            **√âtape 1:** T√©l√©charger l'image a√©rienne du b√¢timent (Vue A√©rienne):
        </label>
        <input type="file" id="imageUpload" accept="image/*">
        
        <label for="scaleFactor" style="margin-top: 15px;">
            **√âtape 2:** Facteur d'√âchelle (Pixels par M√®tre)
            <span style="font-weight: normal; color: #555;">(Ex: Si 1m = 100 pixels, entrez 100)</span>
        </label>
        <input type="number" id="scaleFactor" value="100" min="1" step="1">

        <button id="processButton" onclick="processImage()" disabled style="margin-top: 20px; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
            **√âtape 3:** G√©n√©rer l'Esquisse et les Mesures
        </button>
        
        <progress id="progressBar" value="0" max="100" style="width: 100%; margin-top: 15px; display: none;"></progress>
        <p id="progressPercent" style="margin-top: 5px; font-weight: bold; display: none; color: #28a745;"></p>
    </div>

    <div class="image-display">
        <div class="image-box">
            <h3>Image Originale (Source)</h3>
            <img id="originalImage" alt="Image Originale" style="display:none;">
        </div>
        <div class="image-box">
            <h3>Esquisse Ing√©nierie (Sortie AeroPlan)</h3>
            <canvas id="outputCanvas" style="display:none;"></canvas>
            <div id="measurements" style="text-align: left; margin-top: 15px; font-size: 0.9em;"></div>
            <p id="statusMessage"></p>
        </div>
    </div>
</div>

<script>
    const imageUpload = document.getElementById('imageUpload');
    const originalImage = document.getElementById('originalImage');
    const outputCanvas = document.getElementById('outputCanvas');
    const processButton = document.getElementById('processButton');
    const statusMessage = document.getElementById('statusMessage');
    const measurementsDiv = document.getElementById('measurements');
    const scaleFactorInput = document.getElementById('scaleFactor');
    const ctx = outputCanvas.getContext('2d');

    let imageLoaded = false;

    imageUpload.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                originalImage.src = e.target.result;
                originalImage.style.display = 'block';
                imageLoaded = true;
                processButton.disabled = false;
                outputCanvas.style.display = 'none';
                measurementsDiv.innerHTML = '';
                statusMessage.textContent = 'Image charg√©e. Pr√™t pour AeroPlan...';
            };
            reader.readAsDataURL(file);
        }
    });

    function processImage() {
        if (!imageLoaded) return;

        statusMessage.textContent = 'Traitement en cours...';
        processButton.disabled = true;
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        
        progressBar.style.display = 'block';
        progressPercent.style.display = 'block';
        progressBar.value = 0;
        progressPercent.textContent = '0%';
        measurementsDiv.innerHTML = 'Analyse en cours...';
        
        const scaleFactor = parseFloat(scaleFactorInput.value) || 100; // ŸÇÿ±ÿßÿ°ÿ© ŸÖÿπÿßŸÖŸÑ ÿßŸÑŸÇŸäÿßÿ≥
        
        const img = new Image();
        img.onload = function() {
            outputCanvas.width = img.width;
            outputCanvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, img.width, img.height);
            
            const worker = new Worker('worker.js?v=4'); 
            
            worker.onmessage = function(e) {
                if (e.data.type === 'progress') {
                    progressBar.value = e.data.percent;
                    progressPercent.textContent = e.data.percent + '%';
                    statusMessage.textContent = `G√©n√©ration de l'esquisse... ${e.data.percent}% termin√©`;
                } else if (e.data.type === 'result') {
                    const resultData = new Uint8ClampedArray(e.data.data);
                    const finalImageData = new ImageData(resultData, e.data.width, e.data.height);
                    ctx.putImageData(finalImageData, 0, 0);

                    const analysis = e.data.analysis;

                    // Affichage des mesures
                    let htmlOutput = '<h4>Mesures en Pixels (Approximation):</h4>';
                    htmlOutput += `<li>**Largeur Totale (Overall Width):** ${analysis.overallWidth} px</li>`;
                    htmlOutput += `<li>**Hauteur Totale (Overall Height):** ${analysis.overallHeight} px</li>`;
                    htmlOutput += `<li>**Comptage des Fen√™tres (Window Count):** ${analysis.windowCount}</li>`;
                    htmlOutput += `<li>**Largeur Moyenne Fen√™tre Carr√©e:** ${analysis.squareWindowWidth} px (Approximation)</li>`;
                    htmlOutput += `<li>**Comptage Fen√™tres Arrondies:** ${analysis.roundedWindowCount} (Requires Advanced CV)</li>`;
                    htmlOutput += `<li>**Angle de Pente de Toit (Roof Slope):** ${analysis.slopeAngle}¬∞</li>`;
                    
                    // NOUVEAU: Affichage des mesures en m√®tres (m)
                    htmlOutput += '<div class="unit-conversion">';
                    htmlOutput += '<h4>Conversions en M√®tres (m):</h4>';
                    htmlOutput += `<li>**Facteur d\'√©chelle utilis√©:** 1 m√®tre = ${scaleFactor} pixels</li>`;
                    htmlOutput += `<li>**Largeur Totale (Overall Width):** ${analysis.widthMeters.toFixed(2)} m</li>`;
                    htmlOutput += `<li>**Hauteur Totale (Overall Height):** ${analysis.heightMeters.toFixed(2)} m</li>`;
                    htmlOutput += `<li>**Largeur Moyenne Fen√™tre Carr√©e:** ${analysis.squareWindowWidthMeters.toFixed(2)} m</li>`;
                    htmlOutput += '</div>';

                    measurementsDiv.innerHTML = htmlOutput;

                    statusMessage.textContent = '‚úÖ G√©n√©ration de l\'esquisse termin√©e !';
                    outputCanvas.style.display = 'block';
                    processButton.disabled = false;
                    progressBar.style.display = 'none';
                    progressPercent.style.display = 'none';
                    worker.terminate();
                }
            };

            // D√©marrage du traitement: ÿ•ÿ±ÿ≥ÿßŸÑ ŸÖÿπÿßŸÖŸÑ ÿßŸÑŸÇŸäÿßÿ≥
            worker.postMessage({ 
                imageData, 
                width: img.width, 
                height: img.height,
                scaleFactor: scaleFactor // ÿ•ÿ±ÿ≥ÿßŸÑ ŸÖÿπÿßŸÖŸÑ ÿßŸÑŸÇŸäÿßÿ≥
            }, [imageData.data.buffer]);
        };

        img.src = originalImage.src;
    }
</script>

</body>
</html>
