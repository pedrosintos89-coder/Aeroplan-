<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroPlan | Outil Ã‰co-esthÃ©tique</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
            text-align: center;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #28a745; 
            border-bottom: 3px solid #28a745;
            padding-bottom: 10px;
            margin-bottom: 25px;
        }
        .controls {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px dashed #28a74555;
            border-radius: 8px;
        }
        .controls label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .controls input[type="file"], .controls input[type="number"], .controls select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 90%;
            max-width: 300px;
            margin-top: 5px;
        }
        .image-display {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .image-box {
            width: 48%;
            min-width: 350px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        img, canvas {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        progress {
            accent-color: #28a745;
            height: 15px;
        }
        .unit-conversion {
            margin-top: 20px;
            padding: 15px;
            border-top: 2px solid #28a745;
            border-bottom: 2px solid #28a745;
            margin-top: 25px;
        }
        .action-buttons button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .download-btn {
            background-color: #007bff;
            color: white;
        }
        .clear-btn {
            background-color: #dc3545;
            color: white;
        }
        .auto-mode-checkbox { 
            margin: 15px 0;
            padding: 10px;
            background-color: #e9f7ef;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auto-mode-checkbox input {
            width: auto;
            margin-right: 10px;
        }
        .manual-fields {
            transition: opacity 0.3s ease;
        }
        .manual-fields.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        #groundImagesPreview {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 5px;
            background-color: #fcfcfc;
            border-radius: 5px;
        }
        #groundImagesPreview img {
            max-width: 80px;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ AeroPlan: GÃ©nÃ©rateur de Plans AÃ©riens</h1>
    <p>Outil d'analyse pour la rÃ©novation Ã©co-esthÃ©tique basÃ©e sur le style classique europÃ©en.</p>

    <div class="controls">
        <label for="aerialImageUpload">
            **Ã‰tape 1:** TÃ©lÃ©charger l'image aÃ©rienne du bÃ¢timent (Vue AÃ©rienne):
        </label>
        <input type="file" id="aerialImageUpload" accept="image/*">

        <label for="groundImagesUpload" style="margin-top: 15px;">
            **Ã‰tape 1b (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):** ØªØ­Ù…ÙŠÙ„ ØµÙˆØ± Ø£Ø±Ø¶ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© (Ù„ØªØ­Ø³ÙŠÙ† Ø¯Ù‚Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©):
        </label>
        <input type="file" id="groundImagesUpload" accept="image/*" multiple>
        <div id="groundImagesPreview"></div>
        
        <div class="auto-mode-checkbox">
            <input type="checkbox" id="autoMode" checked>
            <label for="autoMode" style="margin-bottom: 0; font-weight: bold; color: #28a745;">
                **ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù‚ÙŠØ§Ø³Ø§Øª ØªØ®Ù…ÙŠÙ†ÙŠØ©)**
            </label>
        </div>
        
        <div id="manualFields" class="manual-fields disabled">
            <label for="scaleFactor" style="margin-top: 15px;">
                **Ã‰tape 2a (ÙŠØ¯ÙˆÙŠ):** Facteur d'Ã‰chelle (Pixels par MÃ¨tre)
            </label>
            <input type="number" id="scaleFactor" value="100" min="1" step="1">
            
            <label for="floorCount" style="margin-top: 15px; color: #007bff;">
                **Ã‰tape 2b (ÙŠØ¯ÙˆÙŠ):** Nombre d'Ã©tages observÃ©s:
            </label>
            <input type="number" id="floorCount" value="4" min="1" step="1" max="20" style="max-width: 150px;">
        </div>

        <label for="windowType" style="margin-top: 15px; color: #007bff;">
            **Ã‰tape 2c: Assistance AI:** Type de FenÃªtre Dominant (Style Classique):
        </label>
        <select id="windowType" style="max-width: 300px;">
            <option value="square">CarrÃ©e (Murs Plats)</option>
            <option value="arched">Arrondie/CintrÃ©e (Style Classique)</option>
        </select>
        
        <button id="processButton" onclick="processImage()" disabled style="margin-top: 20px; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
            **Ã‰tape 3:** GÃ©nÃ©rer l'Esquisse Ùˆ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³
        </button>
        
        <progress id="progressBar" value="0" max="100" style="width: 100%; margin-top: 15px; display: none;"></progress>
        <p id="progressPercent" style="margin-top: 5px; font-weight: bold; display: none; color: #28a745;"></p>
    </div>

    <div class="image-display">
        <div class="image-box">
            <h3>Image Originale (Source)</h3>
            <img id="originalImage" alt="Image Originale" style="display:none;">
        </div>
        <div class="image-box">
            <h3>Esquisse IngÃ©nierie (Sortie AeroPlan - Ø±Ø³Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³)</h3>
            <canvas id="outputCanvas" style="display:none;"></canvas>
            
            <div id="measurements" style="text-align: left; margin-top: 15px; font-size: 0.9em;"></div>
            <p id="statusMessage"></p>

            <div class="action-buttons" id="actionButtons" style="margin-top: 15px; display: none; justify-content: center;">
                <button class="download-btn" onclick="downloadSketch()">
                    â¬‡ï¸ TÃ©lÃ©charger l'Esquisse (PNG)
                </button>
                <button class="clear-btn" onclick="clearData()">
                    âŒ Effacer les DonnÃ©es
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const aerialImageUpload = document.getElementById('aerialImageUpload');
    const groundImagesUpload = document.getElementById('groundImagesUpload');
    const groundImagesPreview = document.getElementById('groundImagesPreview');
    const originalImage = document.getElementById('originalImage');
    const outputCanvas = document.getElementById('outputCanvas');
    const processButton = document.getElementById('processButton');
    const statusMessage = document.getElementById('statusMessage');
    const measurementsDiv = document.getElementById('measurements');
    const scaleFactorInput = document.getElementById('scaleFactor');
    const floorCountInput = document.getElementById('floorCount');
    const windowTypeInput = document.getElementById('windowType');
    const actionButtons = document.getElementById('actionButtons');
    const autoModeCheckbox = document.getElementById('autoMode');
    const manualFieldsDiv = document.getElementById('manualFields');
    
    let aerialImageLoaded = false;
    let groundImageBuffers = [];
    
    // **NEW: Check if button should be enabled**
    function checkButtonStatus() {
        processButton.disabled = !aerialImageLoaded;
    }
    
    function toggleManualFields() {
        if (autoModeCheckbox.checked) {
            manualFieldsDiv.classList.add('disabled');
        } else {
            manualFieldsDiv.classList.remove('disabled');
        }
    }
    
    toggleManualFields();
    autoModeCheckbox.addEventListener('change', toggleManualFields);

    aerialImageUpload.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                originalImage.src = e.target.result;
                originalImage.style.display = 'block';
                aerialImageLoaded = true; // Set flag to true
                checkButtonStatus(); // Check and enable button
                outputCanvas.style.display = 'none';
                actionButtons.style.display = 'none';
                measurementsDiv.innerHTML = '';
                statusMessage.textContent = 'Image aÃ©rienne chargÃ©e. PrÃªt pour AeroPlan...';
            };
            reader.readAsDataURL(file);
        } else {
            aerialImageLoaded = false;
            checkButtonStatus(); // Check and disable button if file is cleared
        }
    });

    groundImagesUpload.addEventListener('change', async function(event) {
        groundImageBuffers = [];
        groundImagesPreview.innerHTML = '';
        const files = event.target.files;
        if (files.length > 0) {
            statusMessage.textContent = `Chargement de ${files.length} images au sol...`;
            for (const file of files) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                await new Promise(resolve => {
                    reader.onload = async function(e) {
                        const img = new Image();
                        img.src = e.target.result;
                        await new Promise(imgResolve => img.onload = imgResolve);

                        const tempCanvas = document.createElement('canvas');
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCanvas.width = img.width;
                        tempCanvas.height = img.height;
                        tempCtx.drawImage(img, 0, 0);
                        
                        // Push ImageData buffer (only the data is sent to worker)
                        groundImageBuffers.push({
                            data: tempCtx.getImageData(0, 0, img.width, img.height).data.buffer,
                            width: img.width,
                            height: img.height
                        });

                        const thumb = document.createElement('img');
                        thumb.src = e.target.result;
                        groundImagesPreview.appendChild(thumb);
                        resolve();
                    };
                });
            }
            statusMessage.textContent = `${files.length} images au sol chargÃ©es.`;
        }
    });
    
    function downloadSketch() {
        const dataURL = outputCanvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = 'AeroPlan_Esquisse_NettoyÃ©e_' + Date.now() + '.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    
    function clearData() {
        originalImage.src = '';
        originalImage.style.display = 'none';
        outputCanvas.style.display = 'none';
        outputCanvas.width = 0;
        outputCanvas.height = 0;
        
        measurementsDiv.innerHTML = '';
        actionButtons.style.display = 'none';
        aerialImageLoaded = false;
        processButton.disabled = true; 
        groundImageBuffers = [];
        groundImagesPreview.innerHTML = '';
        statusMessage.textContent = 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù…Ø­Ø§Ø©. Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©.';
        
        aerialImageUpload.value = ''; 
        groundImagesUpload.value = '';
    }

    function drawCleanSketch(analysis) {
        const scale = 5; 
        const canvasWidth = analysis.overallWidth / scale;
        const canvasHeight = analysis.overallHeight / scale;
        
        outputCanvas.width = canvasWidth + 40; 
        outputCanvas.height = canvasHeight * 1.5; 
        
        const ctx = outputCanvas.getContext('2d');
        ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
        
        const startX = 20;
        const startY = outputCanvas.height - 20; 
        const bodyWidth = canvasWidth;
        const bodyHeight = canvasHeight * 0.8;
        const roofAngle = analysis.slopeAngle; 

        ctx.strokeStyle = 'black';
        ctx.lineWidth = 1.5;
        
        // 1. Ø±Ø³Ù… Ø¬Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰ (Building Body)
        ctx.strokeRect(startX, startY - bodyHeight, bodyWidth, bodyHeight);
        
        // 2. Ø±Ø³Ù… Ø§Ù„Ø³Ù‚Ù Ø§Ù„Ù…Ø§Ø¦Ù„ (Pitched Roof)
        const roofBaseY = startY - bodyHeight;
        const roofHeight = bodyWidth * Math.tan(roofAngle * Math.PI / 180) * 0.5;
        const roofMidX = startX + bodyWidth / 2;
        
        ctx.beginPath();
        ctx.moveTo(startX, roofBaseY);
        ctx.lineTo(roofMidX, roofBaseY - roofHeight); 
        ctx.lineTo(startX + bodyWidth, roofBaseY);
        ctx.stroke();

        // 3. Ø±Ø³Ù… Ø®Ø·ÙˆØ· Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚ (Floor Lines - AI Assistance)
        const floorHeightPx = bodyHeight / analysis.floorCount;
        for (let i = 1; i < analysis.floorCount; i++) {
            const floorY = startY - (i * floorHeightPx);
            ctx.beginPath();
            ctx.moveTo(startX, floorY);
            ctx.lineTo(startX + bodyWidth, floorY);
            ctx.stroke();
        }
        
        // 4. Ø±Ø³Ù… Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ (Window Approximation)
        const windowSpacing = bodyWidth / (analysis.windowCount + 1);
        const windowWidthPx = (analysis.squareWindowWidth / analysis.overallWidth) * bodyWidth * 0.8; 
        const windowHeightPx = floorHeightPx * 0.5;

        for (let f = 0; f < analysis.floorCount; f++) {
            const floorBaseY = startY - (f * floorHeightPx);
            // Use the final (detected or selected) window type
            const finalWindowType = analysis.detectedWindowType || analysis.windowType; 

            for (let w = 1; w <= analysis.windowCount; w++) {
                const wx = startX + (w * windowSpacing) - (windowWidthPx / 2);
                const wy = floorBaseY - floorHeightPx * 0.75;
                
                if (finalWindowType === 'Arrondie/CintrÃ©e') {
                    ctx.beginPath();
                    ctx.moveTo(wx, wy + windowHeightPx); 
                    ctx.lineTo(wx, wy + windowHeightPx * 0.1); 
                    ctx.arc(wx + windowWidthPx / 2, wy + windowHeightPx * 0.1, windowWidthPx / 2, Math.PI, 0); 
                    ctx.lineTo(wx + windowWidthPx, wy + windowHeightPx); 
                    ctx.closePath();
                    ctx.stroke();
                } else {
                    ctx.strokeRect(wx, wy, windowWidthPx, windowHeightPx);
                }
            }
        }
    }


    function processImage() {
        if (!aerialImageLoaded) {
            statusMessage.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø¬ÙˆÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.';
            return;
        }

        statusMessage.textContent = 'Traitement en cours...';
        processButton.disabled = true;
        actionButtons.style.display = 'none'; 
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        
        progressBar.style.display = 'block';
        progressPercent.style.display = 'block';
        progressBar.value = 0;
        progressPercent.textContent = '0%';
        measurementsDiv.innerHTML = 'Analyse en cours...';
        
        let scaleFactor;
        let floorCount;
        let scaleSource; 

        if (autoModeCheckbox.checked) {
            scaleFactor = 150; 
            floorCount = 5;    
            scaleSource = 'ØªÙ„Ù‚Ø§Ø¦ÙŠ';
        } else {
            scaleFactor = parseFloat(scaleFactorInput.value) || 100; 
            floorCount = parseInt(floorCountInput.value) || 1; 
            scaleSource = 'ÙŠØ¯ÙˆÙŠ';
        }
        
        const windowType = windowTypeInput.value === 'arched' ? 'Arrondie/CintrÃ©e' : 'CarrÃ©e';
        
        const img = new Image();
        img.onload = function() {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            tempCtx.drawImage(img, 0, 0);
            const aerialImageData = tempCtx.getImageData(0, 0, img.width, img.height);
            
            // Prepare Ground Image Data for Transfer
            const groundDataForWorker = groundImageBuffers.map(buffer => ({
                data: new Uint8ClampedArray(buffer.data), // Create a new typed array from buffer
                width: buffer.width,
                height: buffer.height
            }));
            const buffersToTransfer = [aerialImageData.data.buffer, ...groundDataForWorker.map(data => data.data.buffer)];


            const worker = new Worker('worker.js?v=10'); 
            
            worker.onmessage = function(e) {
                if (e.data.type === 'progress') {
                    progressBar.value = e.data.percent;
                    progressPercent.textContent = e.data.percent + '%';
                    statusMessage.textContent = `Analyse des contours... ${e.data.percent}% terminÃ©`;
                } else if (e.data.type === 'result') {
                    const analysis = e.data.analysis;
                    
                    // Display the final window type used
                    const finalWindowType = analysis.detectedWindowType || analysis.windowType;

                    drawCleanSketch(analysis); 

                    let htmlOutput = '<h4>Mesures en Pixels (Approximation):</h4>';
                    htmlOutput += `<li>**Largeur Totale (Overall Width):** ${analysis.overallWidth} px</li>`;
                    htmlOutput += `<li>**Hauteur Totale (Overall Height):** ${analysis.overallHeight} px</li>`;
                    
                    if (scaleSource === 'ØªÙ„Ù‚Ø§Ø¦ÙŠ') {
                        htmlOutput += `<li style="color: #28a745;">**Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (AI):** ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ${analysis.floorCount} Ø·Ø§Ø¨Ù‚ Ùˆ Ù…Ù‚ÙŠØ§Ø³ ${scaleFactor}px/m (ØªØ®Ù…ÙŠÙ†ÙŠ).</li>`;
                    } else {
                        htmlOutput += `<li style="color: #007bff;">**Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙŠØ¯ÙˆÙŠ (AI-Assisted):** ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ${analysis.floorCount} Ø·Ø§Ø¨Ù‚.</li>`;
                    }
                    
                    htmlOutput += `<li>**Ø§Ù„Ù†Ø§ÙØ°Ø© (Square/Arched):** ${analysis.windowCount} (${finalWindowType})</li>`;
                    htmlOutput += `<li>**Angle de Pente de Toit (Roof Slope):** ${analysis.slopeAngle}Â°</li>`;
                    
                    htmlOutput += '<div class="unit-conversion">';
                    htmlOutput += '<h4>Conversions en MÃ¨tres (m):</h4>';
                    htmlOutput += `<li>**Facteur d\'Ã©chelle:** 1 Ù…ØªØ± = ${scaleFactor} pixels</li>`;
                    htmlOutput += `<li>**Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ÙŠ:** ${analysis.widthMeters.toFixed(2)} m</li>`;
                    htmlOutput += `<li>**Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙƒÙ„ÙŠ (ØªÙ‚Ø±ÙŠØ¨ÙŠ):** ${analysis.heightMeters.toFixed(2)} m</li>`;
                    htmlOutput += `<li>**Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø·Ø§Ø¨Ù‚:** ${analysis.floorHeightMeters.toFixed(2)} m (Ù…Ø³ØªÙ†Ø¯ Ù„Ù€ ${analysis.floorCount} Ø·Ø§Ø¨Ù‚)</li>`;
                    htmlOutput += `<li>**Ù…ØªÙˆØ³Ø· Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©:** ${analysis.squareWindowWidthMeters.toFixed(2)} m</li>`;
                    htmlOutput += '</div>';

                    measurementsDiv.innerHTML = htmlOutput;

                    statusMessage.textContent = 'âœ… GÃ©nÃ©ration de l\'esquisse terminÃ©e ! Ø±Ø³Ù… Ù‡Ù†Ø¯Ø³ÙŠ Ù†Ø¸ÙŠÙ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØµÙ…ÙŠÙ….';
                    outputCanvas.style.display = 'block';
                    actionButtons.style.display = 'flex'; 
                    processButton.disabled = false;
                    progressBar.style.display = 'none';
                    progressPercent.style.display = 'none';
                    worker.terminate();
                }
            };

            worker.postMessage({ 
                aerialImageData: aerialImageData, 
                groundImageDataArray: groundDataForWorker, 
                width: img.width, 
                height: img.height,
                scaleFactor: scaleFactor, 
                floorCount: floorCount,    
                windowType: windowType 
            }, buffersToTransfer);
        };

        img.src = originalImage.src;
    }
</script>

</body>
</html>
